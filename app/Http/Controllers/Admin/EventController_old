<?php

namespace App\Http\Controllers\Admin;
use App\Models\Event,
    App\Models\EventTranslate,
    App\Models\Sector,
    App\Models\EventSector,
    App\Models\EventReference,
    App\Models\EventImage,
    App\Models\Exhibitor,
    App\Models\ExhibitorTranslate,
    App\Models\Zone,
    App\Models\Source,
    App\User;
use Auth;
use DB;
use App\Services\Slug;
use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use LaravelLocalization;
use DataTables;
use Carbon\Carbon;

class EventController extends Controller
{
    protected $slug;
    public function __construct()
    {
        $this->slug = new Slug();
        $this->middleware('permission:event-list');
        $this->middleware('permission:event-create', ['only' => ['create','store']]);
        $this->middleware('permission:event-edit', ['only' => ['edit','update']]);
        $this->middleware('permission:event-delete', ['only' => ['destroy']]);
    }
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\View\View
     */
    public function index(Request $request)
    {

        if($request->ajax()){
            $events = Event::with('localeAll','eventSector','eventSector.sector.localeAll');

            return Datatables::eloquent($events)
            ->addIndexColumn()
            ->addColumn('title', function($events){
                foreach($events->localeAll as $events_data) {
                    if($events_data->locale == "en") {
                        $event_name = $events_data->title;
                    }
                }
                return $event_name;
            })
            ->addColumn('sector', function($events) {
                foreach($events->eventSector as $eventSector) {
                    foreach($eventSector->sector->localeAll as $translate){
                        if($translate->locale == "en") {
                            $sector_name[] = $translate->name;
                        }
                    }
                }
                return $sector_name;
            })
            // ->addColumn('description', function($events){
            //     foreach($events->localeAll as $events_data) {
            //         if($events_data->locale == "en") {
            //             $event_description = $events_data->description;
            //         }
            //     }
            //     return strip_tags(str_replace("&nbsp;", "",$event_description));

            // })
            ->addColumn('place', function($events){
                foreach($events->localeAll as $events_data) {
                    if($events_data->locale == "en") {
                        $event_place = $events_data->place;
                    }
                }
                return $event_place;
            })
            ->addColumn('action', function($events){ 
                if (\Auth::user()->can('event-edit')) {
                    $editBtn = '<a href="' . route('manage-event.edit', [$events->id]) . '" title="edit"><i class="fas fa-edit" aria-hidden="true" style="color: #3699FF;"></i></a>&nbsp';
                } else {
                    $editBtn = '';
                } 
                if (\Auth::user()->can('event-delete')) {
                    $deleteBtn = '<a href="javascript:void(0)" data-href="' . route('manage-event.destroy', [$events->id]) . '" rel="tooltip" title="Delete" class="delete_subscription_btn"><i class="far fa-trash-alt" style="color: #F64E60;"></i></a>';
                } else {
                    $deleteBtn = '';
                }
                return $editBtn.$deleteBtn;
            })
            ->editColumn('is_featured', function($events){
                if($events->is_featured == 1) {
                    $is_featured = '<span class="label label-lg font-weight-bold label-light-primary label-inline">Yes</span>';
                    return $is_featured;
                }else {
                    $is_featured = '<span class="label label-inline label-light-danger font-weight-bold">NO</span>';
                    return $is_featured;
                }
            })
            ->editColumn('created_at', function ($events) {
                return [
                   'display' => e($events->created_at->format('m/d/Y')),
                   'timestamp' => $events->created_at->timestamp
                ];
             })
            ->filter(function ($instance) use ($request) {
                if ($request->get('is_featured') == '0' || $request->get('is_featured') == '1') {
                    $instance->where('is_featured', $request->get('is_featured'));
                }
                if (!empty($request->get('search'))) {
                    $instance->whereHas('localeAll', function($w) use($request){
                        $search = $request->get('search');
                        $w->where('title', 'LIKE', "%$search%");
                    });
                }

            })
            ->rawColumns(['action','is_featured'])
            ->make(true);
        }
        return view('admin.event.index');
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\View\View
     */
    public function create()
    {
        try {
            $sectors    = Sector::all();
            $sector_arr = new \stdClass();
            foreach ($sectors as $sector) {
                foreach ($sector->localeAll as $translate) {
                    if ($translate->locale === 'en') {
                        $sector_arr->{$translate->sector_id} = $translate->name;
                    }
                }
            }
            $selected_sectors = null;
            $zones      = Zone::all();
            $zone_arr   = new \stdClass();
            foreach ($zones as $zone) {
                foreach ($zone->localeAll as $translate) {
                    if ($translate->locale === 'en') {
                        $zone_arr->{$translate->zone_id} = $translate->name;
                    }
                }
            }
            $display_order = Exhibitor::max('display_order');
            if($display_order == 0)
                $display_order = 1;
            else
                $display_order++;
            $selected_zones = null;
            $exhibitor = view('admin.event.exhibitors')->render();
            return view('admin.event.create',compact('sector_arr','selected_sectors','selected_zones','zone_arr','display_order','exhibitor'));

        } catch(\Throwable $th) {
            return redirect()->route('manage-event.create')->with('error', 'Something went wrong!');
        }

    }

    /**
     * Store a newly created resource in storage.
     *
     * @param \Illuminate\Http\Request $request
     *
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function store(Request $request)
    {
        $rules = [
            'event_logo'                    => 'required',
            'event_name_in_english'         => 'required',
            'event_name_in_arabic'          => 'required',
            'event_name_in_french'          => 'required',
            'description_in_english'        => 'required',
            'description_in_arabic'         => 'required',
            'description_in_french'         => 'required',
            'place_name_in_english'         => 'required',
            'place_name_in_arabic'          => 'required',
            'place_name_in_french'          => 'required',
            'sectors'                       => 'required|array|min:1',
            'start_date'                    => 'required',
            'price_in_square_meter'         => 'required',
            'organizer_agency_in_english'   => 'required',
            'organizer_agency_in_arabic'    => 'required',
            'organizer_agency_in_french'    => 'required',
            'organizer_address_in_english'  => 'required',
            'organizer_address_in_arabic'   => 'required',
            'organizer_address_in_french'   => 'required',
            'organizer_contact'             => 'required',
            'organizer_email'               => 'required',
            'organizer_website'             => 'nullable|url',
            'exhibitor_name_in_english'     => 'required|array|min:1',
            'exhibitor_name_in_english.0'   => 'required|string|distinct|min:1',
            'exhibitor_name_in_arabic'      => 'required|array|min:1',
            'exhibitor_name_in_arabic.0'    => 'required|string|distinct|min:1',
            'exhibitor_name_in_french'      => 'required|array|min:1',
            'exhibitor_name_in_french.0'    => 'required|string|distinct|min:1',
            'contact'                       => 'required|array|min:1',
            'contact.0'                     => 'required|string|distinct|min:1',
            'display_order'                 => 'required|array|min:1',
            'display_order.0'               => 'required|string|distinct|min:1',
            'exhibitor_logo'                => 'required|array|min:1',
            'exhibitor_logo.0'              => 'required|min:1',
            'zones'                         => 'required|array|min:1',
            'source_name_in_english'        => 'required',
            'source_name_in_arabic'         => 'required',
            'source_name_in_french'         => 'required',
        ];
        $customMessages = [
            'exhibitor_name_in_english.0.required'  => 'The exhibitor name in english field is required.',
            'exhibitor_name_in_arabic.0.required'   => 'The exhibitor name in english field is required.',
            'exhibitor_name_in_french.0.required'   => 'The exhibitor name in english field is required.',
            'contact.0.required'                    => 'The contact no is required.',
            'display_order.0.required'              => 'The display order field is required.',
            'exhibitor_logo.0.required'             => 'The exhibitor logo field is required.',
        ];
        $this->validate($request, $rules, $customMessages);

        if($request->event_type_in_english == null || $request->event_type_in_arabic == null || $request->event_type_in_french == null){
            $request->event_type_in_english = null;
            $request->event_type_in_arabic  = null;
            $request->event_type_in_french  = null;
        }
        if($request->event_edition_in_english == null || $request->event_edition_in_arabic == null || $request->event_edition_in_french == null){
            $request->event_edition_in_english  = null;
            $request->event_edition_in_arabic   = null;
            $request->event_edition_in_french   = null;
        }
        if($request->summary_in_english == null || $request->summary_in_arabic == null || $request->summary_in_french == null){
            $request->summary_in_english    = null;
            $request->summary_in_arabic     = null;
            $request->summary_in_french     = null;
        }

        $exhibitorId                = [];
        $exhibitor_name_in_english  = [];
        $exhibitor_name_in_arabic   = [];
        $exhibitor_name_in_french   = [];
        $contact                    = [];
        $display_order              = [];


        $count_of_id = count($request->exhibitor_id);
        if($count_of_id > 0){

            for($iteration = 0 ; $iteration < $count_of_id; $iteration++ ) {
                if (empty($request->exhibitor_name_in_english[$iteration])) {
                    continue;
                }
                if (empty($request->exhibitor_name_in_arabic[$iteration])) {
                    continue;
                }
                if (empty($request->exhibitor_name_in_french[$iteration])) {
                    continue;
                }
                if (empty($request->contact[$iteration])) {
                    continue;
                }
                if (empty($request->display_order[$iteration])) {
                    continue;
                }

                $exhibitorId[]               = $request->exhibitor_id[$iteration];
                $exhibitor_name_in_english[] = $request->exhibitor_name_in_english[$iteration];
                $exhibitor_name_in_arabic[]  = $request->exhibitor_name_in_arabic[$iteration];
                $exhibitor_name_in_french[]  = $request->exhibitor_name_in_french[$iteration];
                $email[]                     = $request->email[$iteration];
                $contact[]                   = $request->contact[$iteration];
                $display_order[]             = $request->display_order[$iteration];
            }
        }
        $request->exhibitor_id                  = $exhibitorId;
        $request->exhibitor_name_in_english     = $exhibitor_name_in_english;
        $request->exhibitor_name_in_arabic      = $exhibitor_name_in_arabic;
        $request->exhibitor_name_in_french      = $exhibitor_name_in_french;
        $request->contact                       = $contact;
        $request->display_order                 = $display_order;

        DB::beginTransaction();
        try {
            $event_data = [
                [
                    'event_name'        => $request->event_name_in_english,
                    'event_type'        => $request->event_type_in_english,
                    'event_edition'     => $request->event_edition_in_english,
                    'description'       => $request->description_in_english,
                    'summary'           => $request->summary_in_english,
                    'place_name'        => $request->place_name_in_english,
                    'source_name'       => $request->source_name_in_english,
                    'organizer_agency'  => $request->organizer_agency_in_english,
                    'organizer_address' => $request->organizer_address_in_english,
                    'locale'            => "en"
                ],
                [
                    'event_name'        => $request->event_name_in_arabic,
                    'event_type'        => $request->event_type_in_arabic,
                    'event_edition'     => $request->event_edition_in_arabic,
                    'description'       => $request->description_in_arabic,
                    'summary'           => $request->summary_in_arabic,
                    'place_name'        => $request->place_name_in_arabic,
                    'source_name'       => $request->source_name_in_arabic,
                    'organizer_agency'  => $request->organizer_agency_in_arabic,
                    'organizer_address' => $request->organizer_address_in_arabic,
                    'locale'            => "ar"
                ],
                [
                    'event_name'        => $request->event_name_in_french,
                    'event_type'        => $request->event_type_in_french,
                    'event_edition'     => $request->event_edition_in_french,
                    'description'       => $request->description_in_french,
                    'summary'           => $request->summary_in_french,
                    'place_name'        => $request->place_name_in_french,
                    'source_name'       => $request->source_name_in_french,
                    'organizer_agency'  => $request->organizer_agency_in_french,
                    'organizer_address' => $request->organizer_address_in_french,
                    'locale'            => "fr"
                ],
            ];
            $loop = 0;
            foreach($request->exhibitor_name_in_english as $translate) {
                $exhibitor_data[$loop] =
                [
                    [
                        'name'          => $request->exhibitor_name_in_english[$loop],
                        'locale'        => "en",
                    ],
                    [
                        'name'          => $request->exhibitor_name_in_arabic[$loop],
                        'locale'        => "ar",
                    ],
                    [
                        'name'          => $request->exhibitor_name_in_french[$loop],
                        'locale'        => "fr",
                    ],
                ];
                $loop++;
            }

            $image_array = [];
            $explode_removedImage = explode(",", $request->event_image_removed);
            if ($request->event_image) {
                foreach ($request->event_image as $value) {
                    $Image_name = $value->getClientOriginalName();
                    if(!in_array($Image_name, $explode_removedImage)){
                        $image_array[] =$value;
                    }
                }
            }

            $reference_image_array = [];
            $explode_removedReferenceImage = explode(",", $request->reference_image_removed);
            if($request->event_reference) { 
                foreach ($request->event_reference as $value) {
                    $Image_name = $value->getClientOriginalName();
                    if(!in_array($Image_name, $explode_removedReferenceImage)){
                        $reference_image_array[] = $value;
                    }
                }
            }

            $start_date = Carbon::parse($request->start_date);
            $end_date   = Carbon::parse($request->end_date);

            $event = new Event();
            if ($request->hasFile('event_logo')) {
                $eventLogo              = $request->event_logo;
                $eventLogoSaveAsName    = time(). "_event_logo." . $eventLogo->getClientOriginalExtension();
                $upload_path            = storage_path('app/public/uploads/event_logos/');
                $event_image_url        = $eventLogoSaveAsName;
                $success                = $eventLogo->move($upload_path, $eventLogoSaveAsName);
                $event->event_logo      = $eventLogoSaveAsName;
            }
            $event->created_by              = Auth::user()->id;
            $event->updated_by              = Auth::user()->id;
            $event->page_key                = $this->slug->createSlug('event',$request->event_name_in_english);
            $event->start_date              = $start_date;
            $event->end_date                = $end_date;
            $event->is_featured             = isset($request->is_featured)?1:0;
            $event->price_per_square_meter  = $request->price_in_square_meter;
            $event->organizer_contact       = $request->organizer_contact;
            $event->organizer_telephone     = $request->organizer_telephone;
            $event->organizer_mobile        = $request->organizer_mobile;
            $event->organizer_fax           = $request->organizer_fax;
            $event->organizer_email         = $request->organizer_email;
            $event->organizer_website       = $request->organizer_website;

            $result = $event->save();
           
            if($image_array != null) {
                foreach($image_array as $event_image) {
                    $event_images = new EventImage();
                    if ($request->hasFile('event_image')) {
                        $eventImage                 = $event_image;
                        $eventImageSaveAsName       = rand(). "_event_image." . $event_image->getClientOriginalExtension();
                        $upload_path                = storage_path('app/public/uploads/event_images/');
                        $event_image_url            = $eventImageSaveAsName;
                        $success                    = $eventImage->move($upload_path, $eventImageSaveAsName);
                        $event_images->image        = $eventImageSaveAsName;
                    }
                    $event_images->event_id  = $event->id;
                    $event_images->save();
                }
            }
           
            if($request->event_reference != null) {
                if($reference_image_array != null) {
                    foreach($reference_image_array as $event_reference) {
                        $event_references = new EventReference();
                        if ($request->hasFile('event_reference')) {
                            $eventImage                     = $event_reference;
                            $eventImageSaveAsName           = rand(). "_event_reference." . $event_reference->getClientOriginalExtension();
                            $upload_path                    = storage_path('app/public/uploads/event_references/');
                            $event_reference_url            = $eventImageSaveAsName;
                            $success                        = $eventImage->move($upload_path, $eventImageSaveAsName);
                            $event_references->image        = $eventImageSaveAsName;
                        }
                        $event_references->event_id  = $event->id;
                        $event_references->save();
                    }
                }
            }

            $event->sectors()->sync($request->sectors);
            $event->zones()->sync($request->zones);

            foreach($event_data as $key => $value) {
                $event_translation                       = new EventTranslate();

                $event_translation->title                = $value['event_name'];
                $event_translation->event_type           = $value['event_type'];
                $event_translation->event_edition        = $value['event_edition'];
                $event_translation->description          = $value['description'];
                $event_translation->event_summary        = $value['summary'];
                $event_translation->organizer_agency     = $value['organizer_agency'];
                $event_translation->organizer_address    = $value['organizer_address'];
                $event_translation->place                = $value['place_name'];
                $event_translation->source               = $value['source_name'];
                $event_translation->event_id             = $event->id;
                $event_translation->locale               = $value['locale'];

                $event_translation->save();
            }
            $count = 0;

            foreach($request->email as $exhibitors){
                $exhibitor = new Exhibitor();
                if($request->exhibitor_logo != null) {
                    $exhibitorLogo                  = $request->exhibitor_logo[$count];
                    $exhibitorLogoSaveAsName        = rand(). "_exhibitor_logo." . $exhibitorLogo->getClientOriginalExtension();
                    $upload_path                    = storage_path('app/public/uploads/exhibitor_logos/');
                    $exhibitor_image_url            = $eventLogoSaveAsName;
                    $success                        = $exhibitorLogo->move($upload_path, $exhibitorLogoSaveAsName);
                    $exhibitor->exhibitors_logo     = $exhibitorLogoSaveAsName;
                }
                $exhibitor->created_by      = Auth::user()->id;
                $exhibitor->updated_by      = Auth::user()->id;
                $exhibitor->event_id        = $event->id;
                $exhibitor->email_address   = $exhibitors;
                $exhibitor->contact         = $request->contact[$count];
                $exhibitor->display_order   = $request->display_order[$count];
                $exhibitor->status          = isset($request->status[$count])?1:0;
                $exhibitor->save();

                Exhibitor::where('display_order','>=',$request->display_order[$count])
                            ->where('id','!=',$exhibitor->id)
                            ->update(['display_order' => DB::raw('display_order + 1')]);

                foreach($exhibitor_data[$count] as $key => $value){
                    $exhibitor_translate                = new ExhibitorTranslate();

                    $exhibitor_translate->exhibitor_id  = $exhibitor->id;
                    $exhibitor_translate->name          = $value['name'];
                    $exhibitor_translate->locale        = $value['locale'];

                    $exhibitor_translate->save();
                }
                $count ++;
            }

            if($result) {
                DB::commit();
                return redirect('admin/manage-event')->with('success', 'Event added succsessfully.');
            } else {
                DB::rollback();
                return redirect('admin/manage-event')->with('error', 'Something went wrong!');
            }
        } catch(\Exception $e) {
            DB::rollback();
            return redirect()->route('manage-event.index')->with('error', json_encode($e->getMessage()));
        }
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     *
     * @return \Illuminate\View\View
     */
    public function edit($id)
    {
        try {
            $event = Event::with('sectors', 'zones','eventExhibitor','eventExhibitor.localeAll')->findOrFail($id);
            // Setting the translated fields to edit
            foreach ($event->localeAll as $translate) {
                switch ($translate->locale) {
                    case 'en':
                        $event->event_name_in_english           = $translate->title ;
                        $event->event_type_in_english           = $translate->event_type;
                        $event->event_edition_in_english        = $translate->event_edition;
                        $event->description_in_english          = $translate->description;
                        $event->summary_in_english              = $translate->event_summary ;
                        $event->place_name_in_english           = $translate->place;
                        $event->source_name_in_english          = $translate->source;
                        $event->organizer_agency_in_english     = $translate->organizer_agency;
                        $event->organizer_address_in_english    = $translate->organizer_address;
                        break;
                    case 'ar':
                        $event->event_name_in_arabic            = $translate->title;
                        $event->event_type_in_arabic            = $translate->event_type;
                        $event->event_edition_in_arabic         = $translate->event_edition;
                        $event->description_in_arabic           = $translate->description;
                        $event->summary_in_arabic               = $translate->event_summary;
                        $event->place_name_in_arabic            = $translate->place;
                        $event->source_name_in_arabic           = $translate->source;
                        $event->organizer_agency_in_arabic      = $translate->organizer_agency;
                        $event->organizer_address_in_arabic     = $translate->organizer_address;
                        break;
                    case 'fr':
                        $event->event_name_in_french            = $translate->title ;
                        $event->event_type_in_french            = $translate->event_type;
                        $event->event_edition_in_french         = $translate->event_edition;
                        $event->description_in_french           = $translate->description;
                        $event->summary_in_french               = $translate->event_summary;
                        $event->place_name_in_french            = $translate->place;
                        $event->source_name_in_french           = $translate->source;
                        $event->organizer_agency_in_french      = $translate->organizer_agency;
                        $event->organizer_address_in_french     = $translate->organizer_address;
                        break;
                }
            }

            $selected_sectors = [];
            $selected_zones = [];
            foreach ($event->sectors as $sector) {
                $selected_sectors[]= (string)$sector->id;
            }

            foreach ($event->zones as $zone) {
                $selected_zones[]= (string)$zone->id;
            }

            $sectors    = Sector::all();
            $sector_arr = new \stdClass();
            foreach ($sectors as $sector) {
                foreach ($sector->localeAll as $translate) {
                    if ($translate->locale === 'en') {
                        $sector_arr->{$translate->sector_id} = $translate->name;
                    }
                }
            }
            $zones      = Zone::all();
            $zone_arr   = new \stdClass();

            foreach ($zones as $zone) {
                foreach ($zone->localeAll as $translate) {
                    if ($translate->locale === 'en') {
                        $zone_arr->{$translate->zone_id} = $translate->name;
                    }
                }
            }

            $display_order = Exhibitor::max('display_order');
            if($display_order == 0)
                $display_order = 1;
            else
                $display_order;
            $exhibitor = view('admin.event.exhibitors')->render();
            return view('admin.event.edit', compact('event','sector_arr','selected_sectors','zone_arr','selected_zones','exhibitor','display_order'));

        } catch(\Exception $e) {
            return redirect()->route('manage-event.index')->with('error', json_encode($e->getMessage()));
        }
    }

    /**
     * Update the specified resource in storage.
     *
     * @param \Illuminate\Http\Request $request
     * @param  int  $id
     *
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function update(Request $request, $id)
    {
        $rules = [
            'event_name_in_english'         => 'required',
            'event_name_in_arabic'          => 'required',
            'event_name_in_french'          => 'required',
            'description_in_english'        => 'required',
            'description_in_arabic'         => 'required',
            'description_in_french'         => 'required',
            'place_name_in_english'         => 'required',
            'place_name_in_arabic'          => 'required',
            'place_name_in_french'          => 'required',
            'sectors'                       => 'required|array|min:1',
            'start_date'                    => 'required',
            'price_in_square_meter'         => 'required',
            'organizer_agency_in_english'   => 'required',
            'organizer_agency_in_arabic'    => 'required',
            'organizer_agency_in_french'    => 'required',
            'organizer_address_in_english'  => 'required',
            'organizer_address_in_arabic'   => 'required',
            'organizer_address_in_french'   => 'required',
            'organizer_contact'             => 'required',
            'organizer_email'               => 'required',
            'organizer_website'             => 'nullable|url',
            'exhibitor_name_in_english'     => 'required|array|min:1',
            'exhibitor_name_in_english.0'   => 'required|string|distinct|min:1',
            'exhibitor_name_in_arabic'      => 'required|array|min:1',
            'exhibitor_name_in_arabic.0'    => 'required|string|distinct|min:1',
            'exhibitor_name_in_french'      => 'required|array|min:1',
            'exhibitor_name_in_french.0'    => 'required|string|distinct|min:1',
            'contact'                       => 'required|array|min:1',
            'contact.0'                     => 'required|string|distinct|min:1',
            'display_order'                 => 'required|array|min:1',
            'display_order.0'               => 'required|string|distinct|min:1',
            'zones'                         => 'required|array|min:1',
            'source_name_in_english'        => 'required',
            'source_name_in_arabic'         => 'required',
            'source_name_in_french'         => 'required',
        ];
        $customMessages = [
            'exhibitor_name_in_english.0.required'  => 'The exhibitor name in english field is required.',
            'exhibitor_name_in_arabic.0.required'   => 'The exhibitor name in english field is required.',
            'exhibitor_name_in_french.0.required'   => 'The exhibitor name in english field is required.',
            'email.0.required'                      => 'The email field is required.',
            'contact.0.required'                    => 'The contact no is required.',
            'display_order.0.required'              => 'The display order field is required.',
        ];
        $this->validate($request, $rules, $customMessages);
        if($request->event_type_in_english == null || $request->event_type_in_arabic == null || $request->event_type_in_french == null){
            $request->event_type_in_english     = null;
            $request->event_type_in_arabic      = null;
            $request->event_type_in_french      = null;
        }
        if($request->event_edition_in_english == null || $request->event_edition_in_arabic == null || $request->event_edition_in_french == null){
            $request->event_edition_in_english  = null;
            $request->event_edition_in_arabic   = null;
            $request->event_edition_in_french   = null;
        }
        if($request->summary_in_english == null || $request->summary_in_arabic == null || $request->summary_in_french == null){
            $request->summary_in_english    = null;
            $request->summary_in_arabic     = null;
            $request->summary_in_french     = null;
        }

        $exhibitorId                = [];
        $exhibitor_name_in_english  = [];
        $exhibitor_name_in_arabic   = [];
        $exhibitor_name_in_french   = [];
        $contact                    = [];
        $display_order              = [];


        $count_of_id =count($request->exhibitor_id);
        if($count_of_id > 0){

            for($iteration = 0 ; $iteration < $count_of_id; $iteration++ ) {
                if (empty($request->exhibitor_name_in_english[$iteration])) {
                    continue;
                }
                if (empty($request->exhibitor_name_in_arabic[$iteration])) {
                    continue;
                }
                if (empty($request->exhibitor_name_in_french[$iteration])) {
                    continue;
                }
                if (empty($request->contact[$iteration])) {
                    continue;
                }
                if (empty($request->display_order[$iteration])) {
                    continue;
                }

                $exhibitorId[]               = $request->exhibitor_id[$iteration];
                $exhibitor_name_in_english[] = $request->exhibitor_name_in_english[$iteration];
                $exhibitor_name_in_arabic[]  = $request->exhibitor_name_in_arabic[$iteration];
                $exhibitor_name_in_french[]  = $request->exhibitor_name_in_french[$iteration];
                $email[]                     = $request->email[$iteration];
                $contact[]                   = $request->contact[$iteration];
                $display_order[]             = $request->display_order[$iteration];


            }
        }
        $request->exhibitor_id                  = $exhibitorId;
        $request->exhibitor_name_in_english     = $exhibitor_name_in_english;
        $request->exhibitor_name_in_arabic      = $exhibitor_name_in_arabic;
        $request->exhibitor_name_in_french      = $exhibitor_name_in_french;
        $request->email                         = $email;
        $request->contact                       = $contact;
        $request->display_order                 = $display_order;

        DB::beginTransaction();
        try {
            $event = Event::findOrFail($id);
            if ($request->hasFile('event_logo')) {
                if(file_exists('storage/uploads/event_logos/'.$event->event_logo)) {
                    unlink('storage/uploads/event_logos/'.$event->event_logo);
                }
                $eventLogo              = $request->event_logo;
                $eventLogoSaveAsName    = time(). "_event_logo." . $eventLogo->getClientOriginalExtension();
                $upload_path            = storage_path('app/public/uploads/event_logos/');
                $event_image_url        = $eventLogoSaveAsName;
                $success                = $eventLogo->move($upload_path, $eventLogoSaveAsName);
                $event->event_logo      = $eventLogoSaveAsName;
            }

            $image_array = [];
            $explode_removedImage = explode(",", $request->event_image_removed);
            if ($request->event_image) {

                foreach ($request->event_image as $value) {
                    $Image_name = $value->getClientOriginalName();
                    if(!in_array($Image_name, $explode_removedImage)){
                        $image_array[] =$value;
                    }
                }
            }
            $reference_image_array = [];
            $explode_removedReferenceImage = explode(",", $request->reference_image_removed);
            if ($request->event_reference) {

                foreach ($request->event_reference as $value) {
                    $Image_name = $value->getClientOriginalName();
                    if(!in_array($Image_name, $explode_removedReferenceImage)){
                        $reference_image_array[] =$value;
                    }
                }
            }

            $start_date         = Carbon::parse($request->start_date);
            $end_date           = Carbon::parse($request->end_date);
            $event->created_by  = Auth::user()->id;
            $event->updated_by  = Auth::user()->id;

            if($request->englishTitle != $request->event_name_in_english) 
            {
                $event->page_key = $this->slug->createSlug('event',$request->event_name_in_english);
            }

            $event->start_date              = $start_date;
            $event->end_date                = $end_date;
            $event->is_featured             = isset($request->is_featured)?1:0;
            $event->price_per_square_meter  = $request->price_in_square_meter;
            $event->organizer_contact       = $request->organizer_contact;
            $event->organizer_telephone     = $request->organizer_telephone;
            $event->organizer_mobile        = $request->organizer_mobile;
            $event->organizer_fax           = $request->organizer_fax;
            $event->organizer_email         = $request->organizer_email;
            $event->organizer_website       = $request->organizer_website;

            $result = $event->update();

            $trans_events = [
                'en' => [
                    "title"             => $request->event_name_in_english,
                    "description"       => $request->description_in_english,
                    "place"             => $request->place_name_in_english,
                    "event_type"        => $request->event_type_in_english,
                    "event_edition"     => $request->event_edition_in_english,
                    "event_summary"     => $request->summary_in_english,
                    "organizer_agency"  => $request->organizer_agency_in_english,
                    "organizer_address" => $request->organizer_agency_in_english,
                ],
                'fr' => [
                    "title"             => $request->event_name_in_french,
                    "description"       => $request->description_in_french,
                    "place"             => $request->place_name_in_french,
                    "event_type"        => $request->event_type_in_french,
                    "event_edition"     => $request->event_edition_in_french,
                    "event_summary"     => $request->summary_in_french,
                    "organizer_agency"  => $request->organizer_agency_in_french,
                    "organizer_address" => $request->organizer_agency_in_french,
                ],
                'ar' => [
                    "title"             => $request->event_name_in_arabic,
                    "description"       => $request->description_in_arabic,
                    "place"             => $request->place_name_in_arabic,
                    "event_type"        => $request->event_type_in_arabic,
                    "event_edition"     => $request->event_edition_in_arabic,
                    "event_summary"     => $request->summary_in_arabic,
                    "organizer_agency"  => $request->organizer_agency_in_arabic,
                    "organizer_address" => $request->organizer_agency_in_arabic,
                ],
            ];
            foreach(LaravelLocalization::getSupportedLocales() as $localeCode => $properties) {
                EventTranslate::where(
                    [
                        [
                            'event_id', '=', $id
                        ],
                        [
                            'locale', '=', $localeCode
                        ]
                    ])
                    ->update($trans_events[$localeCode]);
            }

            $loop = 0;
            foreach($request->exhibitor_name_in_english as $translate) {
                $exhibitor_data[$loop] =
                [
                    [
                        'name'          => $request->exhibitor_name_in_english[$loop],
                        'locale'        => "en",
                    ],
                    [
                        'name'          => $request->exhibitor_name_in_arabic[$loop],
                        'locale'        => "ar",
                    ],
                    [
                        'name'          => $request->exhibitor_name_in_french[$loop],
                        'locale'        => "fr",
                    ],
                ];
                $loop++;
            }

            $loop=0;
            foreach($request->exhibitor_id as $exhibitor_id) {
                if($exhibitor_id != null) {

                    $exhibitor = Exhibitor::with('localeAll')->findOrFail($exhibitor_id);
                    $trans_exhibitors = [
                        'en' => [
                            "name"         => $request->exhibitor_name_in_english[$loop],
                        ],
                        'fr' => [
                            "name"         => $request->exhibitor_name_in_arabic[$loop],
                        ],
                        'ar' => [
                            "name"         => $request->exhibitor_name_in_french[$loop],
                        ],
                    ];
                    if($request->exhibitor_logo != null) {
                        if(array_key_exists($loop, $request->exhibitor_logo)) {
                            if(file_exists('storage/uploads/exhibitor_logos/'.$exhibitor->exhibitors_logo)) {
                                unlink('storage/uploads/exhibitor_logos/'.$exhibitor->exhibitors_logo);
                            }
                            $exhibitorLogo                  = $request->exhibitor_logo[$loop];
                            $exhibitorLogoSaveAsName        = rand(). "_exhibitor_logo." . $exhibitorLogo->getClientOriginalExtension();
                            $upload_path                    = storage_path('app/public/uploads/exhibitor_logos/');
                            $exhibitor_image_url            = $exhibitorLogoSaveAsName;
                            $success                        = $exhibitorLogo->move($upload_path, $exhibitorLogoSaveAsName);
                            $exhibitor->exhibitors_logo     = $exhibitorLogoSaveAsName;
                        }
                    }
                    $exhibitor->email_address  =  $request->email[$loop];
                    $exhibitor->contact        =  $request->contact[$loop];
                    $exhibitor->display_order  =  $request->display_order[$loop];
                    $exhibitor->status         =  isset($request->status[$loop])?1:0;

                    $exhibitor->update();

                    Exhibitor::where('display_order','>=',$request->display_order[$loop])
                                ->where('id','!=',$exhibitor->id)
                                ->update(['display_order' => DB::raw('display_order + 1')]);

                    foreach(LaravelLocalization::getSupportedLocales() as $localeCode => $properties) {
                        ExhibitorTranslate::where(
                            [
                                [
                                    'exhibitor_id', '=', $exhibitor_id
                                ],
                                [
                                    'locale', '=', $localeCode
                                ]
                            ])
                            ->update($trans_exhibitors[$localeCode]);
                    }

                }else if($exhibitor_id == null) {
                    $exhibitor = new Exhibitor();
                    if(array_key_exists($loop, $request->exhibitor_logo)) {
                        $exhibitorLogo                  = $request->exhibitor_logo[$loop];
                        $exhibitorLogoSaveAsName        = rand(). "_exhibitor_logo." . $exhibitorLogo->getClientOriginalExtension();
                        $upload_path                    = storage_path('app/public/uploads/exhibitor_logos/');
                        $exhibitor_image_url            = $exhibitorLogoSaveAsName;
                        $success                        = $exhibitorLogo->move($upload_path, $exhibitorLogoSaveAsName);
                        $exhibitor->exhibitors_logo     = $exhibitorLogoSaveAsName;
                    }

                    $exhibitor->created_by      = Auth::user()->id;
                    $exhibitor->updated_by      = Auth::user()->id;
                    $exhibitor->event_id        = $id;
                    $exhibitor->email_address   = $request->email[$loop];
                    $exhibitor->contact         = $request->contact[$loop];
                    $exhibitor->display_order   = $request->display_order[$loop];
                    $exhibitor->status          = isset($request->status[$loop])?1:0;

                    $exhibitor->save();

                    Exhibitor::where('display_order','>=',$request->display_order[$loop])
                                ->where('id','!=',$exhibitor->id)
                                ->update(['display_order' => DB::raw('display_order + 1')]);

                    foreach($exhibitor_data[$loop] as $key => $value){
                        $exhibitor_translate                = new ExhibitorTranslate();

                        $exhibitor_translate->exhibitor_id  = $exhibitor->id;
                        $exhibitor_translate->name          = $value['name'];
                        $exhibitor_translate->locale        = $value['locale'];

                        $exhibitor_translate->save();
                    }
                }
                $loop++;
            }

            $event->sectors()->sync($request->sectors);
            $event->zones()->sync($request->zones);

            if ($request->hasFile('event_image')) {
                foreach($image_array as $event_image) {
                    $event_images = new EventImage();
                    if ($request->hasFile('event_image')) {
                        $eventImage             = $event_image;
                        $eventImageSaveAsName   = rand(). "_event_image." . $event_image->getClientOriginalExtension();
                        $upload_path            = storage_path('app/public/uploads/event_images/');
                        $event_image_url        = $eventImageSaveAsName;
                        $success                = $eventImage->move($upload_path, $eventImageSaveAsName);
                        $event_images->image    = $eventImageSaveAsName;
                    }
                    $event_images->event_id  = $id;
                    $event_images->save();
                }
            }

            if($request->event_reference != null) {
                foreach($reference_image_array as $event_reference) {
                    $event_references = new EventReference();
                    if ($request->hasFile('event_reference')) {
                        $eventImage                  = $event_reference;
                        $eventImageSaveAsName        = rand(). "_event_reference." . $event_reference->getClientOriginalExtension();
                        $upload_path                 = storage_path('app/public/uploads/event_references/');
                        $event_reference_url         = $eventImageSaveAsName;
                        $success                     = $eventImage->move($upload_path, $eventImageSaveAsName);
                        $event_references->image     = $eventImageSaveAsName;
                    }
                    $event_references->event_id  = $id;
                    $event_references->save();
                }
            }

            if($result) {
                DB::commit();
                return redirect('admin/manage-event')->with('success', 'Event updated successfully.');
            } else {
                DB::rollback();
                return redirect('admin/manage-event')->with('error', 'Something went wrong!');
            }
        } catch(\Exception $e) {
            return redirect()->route('manage-event.index')->with('error', json_encode($e->getMessage()));
        }
    }

     /**
     * Remove the specified resource image from storage.
     *
     * @param  int  $id
     *
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function imageDestroy(Request $request)
    {
        try {
            $eventImage= EventImage::find($request->delete);
            if(file_exists('storage/uploads/event_images/'.$eventImage->image)) {
                unlink('storage/uploads/event_images/'.$eventImage->image);
            }
            $eventImage->delete();

            return redirect()->back()->with('success', 'Event Image deleted successfully.');

        } catch(\Exception $e) {
            return redirect()->route('manage-event.index')->with('error', json_encode($e->getMessage()));
        }
    }

    /**
     * Remove the specified resource reference from storage.
     *
     * @param  int  $id
     *
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function referenceDestroy(Request $request)
    {
        try {
            $eventReference= EventReference::find($request->delete);
            if(file_exists('storage/uploads/event_references/'.$eventReference->image)) {
                unlink('storage/uploads/event_references/'.$eventReference->image);
            }
            $eventReference->delete();

            return redirect()->back()->with('success', 'Event Reference deleted successfully.');

        } catch(\Exception $e) {
            return redirect()->route('manage-event.index')->with('error', json_encode($e->getMessage()));
        }
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     *
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function destroy(Request $request,$id)
    {
        try {
            $event = Event::with('localeAll','eventImage','eventSector')->find($id);
            $event = Event::with('sectors', 'zones','eventExhibitor','eventExhibitor.localeAll')->findOrFail($id);

            foreach($event->eventImage as $eventImage) {
                if(file_exists('storage/uploads/event_images/'.$eventImage->image)) {
                    unlink('storage/uploads/event_images/'.$eventImage->image);
                }
            }
            $event->localeAll()->delete();
            $event->eventImage()->delete();
            $event->sectors()->detach();
            $event->zones()->detach();
            $event->eventExhibitor()->delete();
            $event->delete();
            $request->session()->flash('success', 'Event deleted successfully.');
            return redirect()->route('manage-event.index');

        } catch(\Throwable $th) {
            return redirect()->route('manage-event.index')->with('error', 'Something went wrong!');
        }
    }

     /**
     * Remove the specified resource image from storage.
     *
     * @param  int  $id
     *
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function deleteExhibitor(Request $request)
    {
        try {
            $exhibitor= Exhibitor::with('localeAll')->find($request->delete);
            $exhibitor->localeAll()->delete();
            $exhibitor->delete();
            return redirect()->back()->with('success', 'Exhibitor deleted successfully.');
        } catch(\Exception $e) {
            return redirect()->route('manage-event.index')->with('error', json_encode($e->getMessage()));
        }
    }
}
